*** Settings ***
Library  SeleniumLibrary
Library  ThreatPlaybook  Altoro Mutual
Library  Collections
Library  RoboZap  http://127.0.0.1:8090/  8090
Library  RoboNmap
Library  RoboWFuzz  directory-list-1.0.txt
Library  RoboShodan  VJ3MRKdVyd5dkd8LK1jLAWtyp2OaoNvs
Library  RoboSslyze
Library  OperatingSystem

*** Variables ***
${TARGET_NAME}  Altoro Mutual Banking App
${TARGET_URI}  altoromutual.com
${TARGET_HOST}  altoromutual.com
${SSL_TARGET}  altoromutual.com
${TARGET_IP}  65.61.137.117
#CONFIG
${RESULTS_PATH}  /Users/abhaybhargav/Documents/Code/Python/defcon26/pentest_pipeline/results

#WFUZZ
${WFUZZ_FILE}  directory_brute.json

#Sslyze
${SSLYZE_JSON}  /Users/abhaybhargav/Documents/Code/Python/defcon26/pentest_pipeline/results/sslyze.json

#ZAP
${ZAP_PATH}  /Applications/OWASP_ZAP.app/Contents/Java/
${APPNAME}  Altoro Mutual Banking App
${CONTEXT}  Altoro_Mutual
${REPORT_TITLE}  Altoro Mutual Banking App Test Report - ZAP
${REPORT_FORMAT}  json
${ZAP_REPORT_FILE}  altoro.json
${REPORT_AUTHOR}  Abhay Bhargav
${SCANPOLICY}  Light

*** Test Cases ***
Create Targets
    find or create target  ${TARGET_NAME}  ${TARGET_URI}

Apply Shodan Results to IP Address
    run shodan scan  ${RESULTS_PATH}  ${TARGET_IP}
    create and link recon  shodan  ${TARGET_NAME}  file_name=${RESULTS_PATH}/shodan.json

Port Scan and Service Enumeration
    nmap script scan  ${TARGET_HOST}  file_export=${RESULTS_PATH}/nmap.txt
    nmap print results
    create and link recon  nmap  ${TARGET_NAME}  file_name=${RESULTS_PATH}/nmap.txt

Directory Bruteforce
    [Timeout]  30 seconds
    brute directories  http://${TARGET_URI}/FUZZ  concur=3  file_name=${RESULTS_PATH}/${WFUZZ_FILE}

Link Dir Brute Result
    create and link recon  wfuzz  ${TARGET_NAME}  file_name=${RESULTS_PATH}/${WFUZZ_FILE}

Test for SSL
    test ssl basic  ${SSL_TARGET}
    test ssl server headers  ${SSL_TARGET}
    write results to json file  json_file=${SSLYZE_JSON}
    create and link recon  sslyze  ${TARGET_NAME}  file_name=${RESULTS_PATH}/sslyze.json

Initialize ZAP
    [Tags]  walk
    start gui zap  ${ZAP_PATH}
    sleep  10
    zap open url  http://${TARGET_URI}

Open Browser and Initialize Walkthrough
    [Tags]  walk
    set Environment Variable  webdriver.chrome.driver  /Users/abhaybhargav/Documents/Code/Python/ZapRobotSelenium/chromedriver
    ${list} =  Create List  --proxy-server=http://127.0.0.1:8090
    ${args} =  Create Dictionary  args=${list}
    ${desired_caps} =  Create Dictionary  chromeOptions=${args}
    create webdriver  Chrome  desired_capabilities=${desired_caps}
    go to  http://${TARGET_URI}

Walkthrough Altoro Mutual App
    [Tags]  walk
    Click Link  //a[@id="_ctl0__ctl0_Content_AccountLink"]
    Input Text  //input[@name="uid"]    admin
    Input Text  //input[@name="passw"]    admin
    Click Element  //input[@name="btnSubmit"]
    Click Link  //a[@id="_ctl0__ctl0_Content_MenuHyperLink1"]
    Click Link  //a[@id="_ctl0__ctl0_Content_MenuHyperLink2"]
    Input Text  //input[@name="after"]    01/01/2001
    Input Text  //input[@name="before"]    01/01/2008
    Click Link  //a[@id="_ctl0__ctl0_Content_MenuHyperLink1"]
    Click Element  //input[@id="btnGetAccount"]

ZAP Contextualize
    [Tags]  zap_context
    ${contextid}=  zap define context  ${CONTEXT}  http://${TARGET_URI}
    set suite variable  ${CONTEXT_ID}  ${contextid}

ZAP Active Scan
    [Tags]  zap_scan
    ${scan_id}=  zap start ascan  ${CONTEXT_ID}  http://${TARGET_URI}  ${SCANPOLICY}
    set suite variable  ${SCAN_ID}  ${scan_id}
    zap scan status  ${scan_id}

ZAP Generate Report
    [Tags]  zap_generate_report
    zap export report  ${RESULTS_PATH}/${ZAP_REPORT_FILE}  ${REPORT_FORMAT}  ${REPORT_TITLE}  ${REPORT_AUTHOR}

Write ZAP Results to DB
    parse zap json  ${RESULTS_PATH}/${ZAP_REPORT_FILE}  ${TARGET_NAME}  ${TARGET_URI}

ZAP Die
    zap shutdown

Close App
    close browser

Write Final Report
    ${all_false}=  convert to boolean  False
    write markdown report  gen_diagram=${all_false}  gen_threat_model=${all_false}